<!DOCTYPE html>
<html>
<body>
<h1>It works!</h1>
<button onclick="download()">Test file download</button>
<script>
const readAsArray = (blob) => new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = () => resolve(Array.from(new Uint8Array(fr.result)));
    fr.onerror = () => reject(fr.error);
    fr.readAsArrayBuffer(blob);
})
const download = async () => {
    const blob = new Blob([
        new Uint8Array("Hello, world!".split("").map(i => i.charCodeAt(0)))
    ], {
        type: "text/plain"
    });
    webkit.messageHandlers.download.postMessage({
        name: "test.txt",
        data: await readAsArray(blob)
    });
};
</script>
</body>
</html>
